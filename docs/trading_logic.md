# Бизнес-логика торгового бота

## Общий цикл работы

Каждые 60 секунд для каждой торговой пары выполняется цикл анализа:

1. Сбор данных (активность сообщества, FUD-активность, свечи Ichimoku)
2. Технический анализ
3. Анализ сентимента нейронкой (Claude)
4. Сравнение сигналов
5. Принятие решения

---

## 1. Технический анализ (MakeTradingDecision)

### Входные данные:
- Анализ Ichimoku (облако, тенкан, киджун и т.д.)
- Анализ активности сообщества (резкий рост/падение/плато)
- Анализ FUD-активности (негативные сообщения)
- Текущая позиция (LONG/SHORT/нет позиции)

### Подсчет сигналов:

#### Сигналы LONG (покупка):
- **Ichimoku Strong LONG**: +3 балла (цена пробила облако вверх)
- **Ichimoku LONG**: +2 балла (цена выше облака)
- **Резкий рост активности**: +1 балл (сообщений стало >50% больше)

#### Сигналы SHORT (продажа):
- **Ichimoku Strong SHORT**: +3 балла (цена пробила облако вниз)
- **Ichimoku SHORT**: +2 балла (цена ниже облака)
- **Резкое падение активности**: +1 балл (сообщений стало <50% меньше)
- **Резкий рост FUD**: +1 балл (негативных сообщений стало >50% больше)

### Логика принятия решений:

#### Ветвление 1: Противоречие Ichimoku LONG с негативным сентиментом
**Условие**: Ichimoku показывает LONG, НО активность падает ИЛИ FUD растет
- Если есть открытая LONG позиция → **ЗАКРЫТЬ LONG** (strength=Medium)
- Если позиции нет → **HOLD** (не открываем позицию)

#### Ветвление 2: Противоречие Ichimoku SHORT с позитивным сентиментом
**Условие**: Ichimoku показывает SHORT, НО активность растет
- Если есть открытая SHORT позиция → **ЗАКРЫТЬ SHORT** (strength=Medium)
- Если позиции нет → **HOLD** (не открываем позицию)

#### Ветвление 3: Ichimoku нейтрален, но есть активность
**Условие**: Ichimoku неопределен/нейтрален, но активность НЕ плато
- Если активность растет → **ОТКРЫТЬ LONG** (strength=Weak)
- Если активность падает ИЛИ FUD растет → **ОТКРЫТЬ SHORT** (strength=Weak)

#### Ветвление 4: Равенство сигналов (плато)
**Условие**: longSignals == shortSignals И есть открытая позиция
- LONG открыт → **ЗАКРЫТЬ LONG** (strength=Medium)
- SHORT открыт → **ЗАКРЫТЬ SHORT** (strength=Medium)
- Нет позиции → **HOLD** (strength=None)

#### Ветвление 5: Больше LONG сигналов
**Условие**: longSignals > shortSignals
- Если открыт SHORT → **ЗАКРЫТЬ SHORT** + strength = getStrength(longSignals)
- Если нет позиции → **ОТКРЫТЬ LONG** + strength = getStrength(longSignals)
- Если уже в LONG → **HOLD** (strength=None)

#### Ветвление 6: Больше SHORT сигналов
**Условие**: shortSignals > longSignals
- Если открыт LONG → **ЗАКРЫТЬ LONG** + strength = getStrength(shortSignals)
- Если нет позиции → **ОТКРЫТЬ SHORT** + strength = getStrength(shortSignals)
- Если уже в SHORT → **HOLD** (strength=None)

#### Ветвление 7: Нет сигналов
**Условие**: Все остальные случаи
- **HOLD** (strength=None)

### Расчет силы сигнала (getStrength):
- **≥5 баллов** → Strong (сильный)
- **≥3 баллов** → Medium (средний)
- **≥1 балл** → Weak (слабый)
- **0 баллов** → None (нет сигнала)

---

## 2. Анализ сентимента (MakeSentimentTradingDecision)

### Входные данные:
- Анализ Claude (сентимент от -10 до +10, тренд, уровень FUD, confidence)
- Текущая позиция

### Категории сентимента:
- **Отличный**: >7 (сильный бычий сигнал)
- **Средний**: 2-7 (нейтрально, смотрим на тренд)
- **Плохой**: <2 (медвежий сигнал, редкость из-за модерации)

### Категории тренда:
- **improving**: Радость растет (бычий сигнал)
- **declining**: Радость падает (медвежий сигнал, даже если сентимент все еще позитивный!)
- **stable**: Стабильно

### Уровень FUD:
- **≥6**: Высокий страх, сильный медвежий сигнал

### Логика принятия решений:

#### Ветвление 1: Позитивный сигнал
**Условие**: Сентимент >7 ИЛИ (сентимент 2-7 И тренд improving)
- Если открыт SHORT → **ЗАКРЫТЬ SHORT** (strength=Medium)
- Если нет позиции → **ОТКРЫТЬ LONG** (strength=Strong если >7, иначе Medium)
- Если уже в LONG → **HOLD** (strength=None)

#### Ветвление 2: Негативный сигнал
**Условие**: Тренд declining ИЛИ FUD ≥6
- Если открыт LONG → **ЗАКРЫТЬ LONG** (strength=Medium)
- Если нет позиции → **ОТКРЫТЬ SHORT** (strength=Strong если FUD≥6, иначе Medium)
- Если уже в SHORT → **HOLD** (strength=None)

#### Ветвление 3: Нейтральный сигнал
**Условие**: Все остальные случаи
- **HOLD** (strength=None)

#### Корректировка по уверенности:
**Условие**: Confidence <0.5
- Снижаем strength до Weak для любого действия

---

## 3. Основной алгоритм принятия решений (processTradingCycle)

### Шаг 1: Получение технического сигнала
Вызывается `MakeTradingDecision()` → получаем `signal` (action + strength + reasons)

### Шаг 2: Получение сигнала от нейронки
**Если Claude настроен:**
1. Получаем последние 50 твитов
2. **Проверяем наличие новых твитов** (сравниваем ID последнего твита)
   - **Есть новые твиты** → анализируем Claude → преобразуем в `sentimentSignal` через `MakeSentimentTradingDecision()`
   - **Нет новых твитов** → используем кешированный `sentimentSignal` из предыдущего анализа
   - **Ошибка анализа** → используем кеш (если есть)
3. Сохраняем результат в state.LastSentimentSignal

**Если Claude не настроен:**
- `sentimentSignal` остается пустым

### Шаг 3: Сравнение сигналов
**Если есть sentimentSignal.Action:**

#### Вариант А: Сигналы совпадают
**Условие**: signal.Action == sentimentSignal.Action
- ✓ Продолжаем дальше с техническим сигналом

#### Вариант Б: Сигналы расходятся
**Условие**: signal.Action != sentimentSignal.Action
- **Если открыт LONG** → **ЗАКРЫТЬ LONG** → ВЫХОД
- **Если открыт SHORT** → **ЗАКРЫТЬ SHORT** → ВЫХОД
- **Если позиции нет** → **ПРОПУСКАЕМ действие** → ВЫХОД

**Если нет sentimentSignal:**
- Продолжаем только с техническим сигналом

### Шаг 4: Проверка силы сигнала
**Условие**: signal.Strength < Medium (т.е. Weak или None)
- **Если открыт LONG** → **ЗАКРЫТЬ LONG** → ВЫХОД
- **Если открыт SHORT** → **ЗАКРЫТЬ SHORT** → ВЫХОД
- **Если позиции нет** → ВЫХОД (ничего не делаем)

### Шаг 5: Проверка времени удержания позиции
**Условие**: Позиция открыта дольше 24 часов
- **Принудительно закрываем позицию** (LONG или SHORT) → ВЫХОД

### Шаг 6: Выполнение действия
Выполняем `signal.Action`:

#### OPEN_LONG:
1. Получаем текущую цену
2. Открываем LONG позицию с указанным leverage и quantity
3. Обновляем state.CurrentPosition = LONG
4. Запоминаем время открытия

#### OPEN_SHORT:
1. Получаем текущую цену
2. Открываем SHORT позицию с указанным leverage и quantity
3. Обновляем state.CurrentPosition = SHORT
4. Запоминаем время открытия

#### CLOSE_LONG:
1. Закрываем LONG позицию
2. Обновляем state.CurrentPosition = BOTH (нет позиции)

#### CLOSE_SHORT:
1. Закрываем SHORT позицию
2. Обновляем state.CurrentPosition = BOTH (нет позиции)

#### HOLD:
- Ничего не делаем, логируем состояние

---

## Сводка критических правил:

1. **Расхождение сигналов** → всегда закрываем позицию (или пропускаем открытие)
2. **Слабый технический сигнал** → закрываем позицию, не открываем новую
3. **Позиция >24 часов** → принудительно закрываем
4. **Нет новых твитов** → используем кешированный анализ сентимента
5. **Contradiction в техническом анализе** → закрываем противоречащую позицию или HOLD
6. **Declining trend в сентименте** → медвежий сигнал, даже если сентимент все еще положительный

---

## Приоритет сигналов:

1. **Расхождение technical vs sentiment** (самый высокий) → закрываем позицию
2. **Слабый сигнал (strength<Medium)** → закрываем позицию
3. **Время >24ч** → закрываем позицию
4. **Совпадение сигналов** → выполняем действие
