<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUD Trading Bot - Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
            color: #00ff88;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid #00ff88;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 10px;
        }

        .chart-container {
            background: rgba(10, 14, 39, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .chart-title {
            color: #00ccff;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        #balanceChart {
            max-height: 400px;
        }

        .result-positive {
            color: #00ff88;
        }

        .result-negative {
            color: #ff4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00ccff;
        }

        .modal-title {
            font-size: 1.8em;
            color: #00ff88;
        }

        .close-btn {
            background: rgba(255, 68, 68, 0.3);
            border: 2px solid #ff4444;
            color: #ff4444;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 68, 68, 0.5);
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .section-title {
            color: #00ccff;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: rgba(0, 204, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00ccff;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #00ff88;
            font-size: 1.2em;
            font-weight: bold;
        }

        .history-item {
            background: rgba(0, 204, 255, 0.05);
            border: 1px solid #00ccff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-action {
            font-size: 1.1em;
            color: #00ff88;
            font-weight: bold;
            text-transform: uppercase;
        }

        .history-time {
            color: #888;
            font-size: 0.9em;
        }

        .history-reason {
            color: #00ccff;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .trend-graph {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .trend-item {
            background: rgba(10, 14, 39, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00ccff;
            text-align: center;
        }

        .trend-label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .trend-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .trend-up { color: #00ff88; }
        .trend-down { color: #ff4444; }
        .trend-flat { color: #ffaa00; }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.7);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: #00ccff;
        }

        .decisions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .decision-group {
            background: rgba(0, 204, 255, 0.05);
            border: 1px solid #00ccff;
            border-radius: 10px;
            padding: 15px;
        }

        .decision-group-header {
            color: #00ff88;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ccff;
        }

        .decision-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .decision-item {
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .decision-item:hover {
            background: rgba(0, 204, 255, 0.15);
            transform: translateX(5px);
        }

        .decision-time {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .decision-signals {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .decision-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .badge-long {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .badge-short {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .badge-empty {
            background: rgba(255, 170, 0, 0.3);
            border: 1px solid #ffaa00;
            color: #ffaa00;
        }

        .signal-icon {
            font-size: 1.1em;
            cursor: help;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .signal-icon:hover {
            transform: scale(1.1);
        }

        .signal-bg-long {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }

        .signal-bg-short {
            background: rgba(255, 68, 68, 0.3);
            border-color: #ff4444;
        }

        .signal-bg-empty {
            background: rgba(128, 128, 128, 0.3);
            border-color: #888;
        }

        .fud-attack-warning {
            color: #ff4444;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .explanation-text {
            background: rgba(0, 204, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00ccff;
            color: #00ff88;
            line-height: 1.6;
        }

        .positions-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 10px;
        }

        .position-card {
            background: rgba(0, 204, 255, 0.05);
            border: 2px solid #00ccff;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .position-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .position-long {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }

        .position-short {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.05);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 204, 255, 0.3);
        }

        .position-symbol {
            font-size: 1.4em;
            font-weight: bold;
            color: #00ff88;
        }

        .position-side-badge {
            padding: 6px 16px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .position-side-badge.long {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .position-side-badge.short {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .position-info {
            margin-bottom: 15px;
        }

        .position-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 204, 255, 0.1);
        }

        .position-info-row .label {
            color: #888;
            font-size: 0.9em;
        }

        .position-info-row .value {
            color: #00ccff;
            font-weight: bold;
        }

        .position-pl {
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .position-status {
            text-align: center;
            margin-bottom: 10px;
        }

        .status-open {
            color: #00ff88;
            font-weight: bold;
            padding: 4px 12px;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 6px;
        }

        .status-closed {
            color: #888;
            font-weight: bold;
            padding: 4px 12px;
            background: rgba(128, 128, 128, 0.2);
            border-radius: 6px;
        }

        .position-time {
            color: #666;
            font-size: 0.85em;
            text-align: center;
        }

        .modal-position {
            max-width: 1200px;
        }

        .decisions-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .decision-card {
            background: rgba(0, 204, 255, 0.05);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .decision-number {
            display: inline-block;
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .snapshots-chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 204, 255, 0.05);
            border-radius: 8px;
        }

        .chart-toggle {
            padding: 8px 16px;
            border: 2px solid #00ccff;
            background: rgba(0, 204, 255, 0.1);
            color: #00ccff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .chart-toggle.active {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            color: #00ff88;
        }

        .chart-toggle:hover {
            background: rgba(0, 204, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>📊 FUD Trading Bot Dashboard</h1>
            </div>

            <div v-if="loading" class="loading">
                ⚡ Loading data...
            </div>

            <template v-else>
                <div class="chart-container">
                    <div class="chart-title">Account Balance History</div>
                    <div class="chart-controls">
                        <label style="color: #00ccff; margin-right: 15px;">Asset:</label>
                        <select v-model="selectedAsset" @change="onAssetChange" style="padding: 8px 16px; border: 2px solid #00ccff; background: rgba(0, 204, 255, 0.1); color: #00ccff; border-radius: 6px; cursor: pointer; font-family: 'Courier New', monospace;">
                            <option v-for="asset in assets" :key="asset" :value="asset">{{ asset }}</option>
                        </select>
                    </div>
                    <canvas id="balanceChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Positions</div>
                    <div class="positions-container">
                        <div v-for="position in positions" :key="position.uuid" 
                             class="position-card"
                             :class="{'position-long': position.side === 'LONG', 'position-short': position.side === 'SHORT'}"
                             @click="openPositionDetail(position.uuid)">
                            <div class="position-header">
                                <div class="position-symbol">{{ position.symbol }}</div>
                                <div class="position-side-badge" :class="position.side.toLowerCase()">
                                    {{ position.side }}
                                </div>
                            </div>
                            <div class="position-info">
                                <div class="position-info-row">
                                    <span class="label">Entry:</span>
                                    <span class="value">${{ position.entry_price.toFixed(4) }}</span>
                                </div>
                                <div class="position-info-row" v-if="position.is_closed">
                                    <span class="label">Exit:</span>
                                    <span class="value">${{ position.close_price.toFixed(4) }}</span>
                                </div>
                                <div class="position-info-row">
                                    <span class="label">Quantity:</span>
                                    <span class="value">{{ position.quantity.toFixed(4) }}</span>
                                </div>
                                <div class="position-info-row">
                                    <span class="label">Leverage:</span>
                                    <span class="value">{{ position.leverage }}x</span>
                                </div>
                            </div>
                            <div class="position-pl" :class="position.realized_pl >= 0 ? 'result-positive' : 'result-negative'">
                                {{ position.realized_pl >= 0 ? '+' : '' }}${{ position.realized_pl.toFixed(2) }}
                            </div>
                            <div class="position-status">
                                <span v-if="position.is_closed" class="status-closed">CLOSED</span>
                                <span v-else class="status-open">OPEN</span>
                            </div>
                            <div class="position-time">
                                {{ formatDateTime(position.opened_at) }}
                                <span v-if="position.is_closed"> - {{ formatDateTime(position.closed_at) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Trading Decisions</div>
                    <div class="decisions-container">
                        <div v-for="(decisions, symbol) in groupedDecisions" :key="symbol" class="decision-group">
                            <div class="decision-group-header">{{ symbol }}</div>
                            <div class="decision-list">
                                <div v-for="decision in decisions.slice(0, 10)" 
                                     :key="decision.id" 
                                     class="decision-item"
                                     @click="openDecisionDetail(decision.id)">
                                    <div class="decision-time">{{ formatTime(decision.created_at) }}</div>
                                    <div class="decision-signals">
                                        <span class="decision-badge" 
                                              :class="'badge-' + decision.decision.toLowerCase()"
                                              :title="getDecisionTooltip(decision.decision)">
                                            {{ decision.decision }}
                                        </span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.btc_ichimoku.toLowerCase()"
                                              :title="getSignalTooltip('BTC Ichimoku', decision.btc_ichimoku)">₿</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.coin_ichimoku.toLowerCase()"
                                              :title="getSignalTooltip('Coin Ichimoku', decision.coin_ichimoku)">🪙</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.activity.toLowerCase()"
                                              :title="getSignalTooltip('Community Activity', decision.activity)">📊</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.fud_activity.toLowerCase()"
                                              :title="getSignalTooltip('FUD Activity', decision.fud_activity)">⚡</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.sentiment.toLowerCase()"
                                              :title="getSignalTooltip('Sentiment', decision.sentiment)">💭</span>
                                        <span v-if="decision.fud_attack === 'yes'" 
                                              class="signal-icon fud-attack-warning" 
                                              title="⚠️ FUD Attack: Coordinated negative campaign detected">⚠️</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>


            <div class="modal" :class="{ active: showDecisionModal }" @click.self="closeDecisionModal">
                <div class="modal-content" v-if="selectedDecision">
                    <div class="modal-header">
                        <div class="modal-title">Decision Details: {{ selectedDecision.Symbol }}</div>
                        <button class="close-btn" @click="closeDecisionModal">Close</button>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Decision Information</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Final Decision</div>
                                <div class="info-value" :class="'badge-' + selectedDecision.FinalDecision.toLowerCase()">
                                    {{ selectedDecision.FinalDecision }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Position UUID</div>
                                <div class="info-value" style="font-size: 0.8em;">{{ selectedDecision.PositionUUID || 'N/A' }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date</div>
                                <div class="info-value">{{ formatDateTime(selectedDecision.CreatedAt) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">FUD Attack</div>
                                <div class="info-value" :class="selectedDecision.FudAttack === 'yes' ? 'result-negative' : 'result-positive'">
                                    {{ selectedDecision.FudAttack === 'yes' ? 'YES ⚠️' : 'NO' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Signal Analysis</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">BTC Ichimoku</div>
                                <div class="info-value">{{ selectedDecision.BTCIchimoku }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Coin Ichimoku</div>
                                <div class="info-value">{{ selectedDecision.CoinIchimoku }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Activity</div>
                                <div class="info-value">{{ selectedDecision.Activity }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">FUD Activity</div>
                                <div class="info-value">{{ selectedDecision.FudActivity }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Sentiment</div>
                                <div class="info-value">{{ selectedDecision.Sentiment }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Explanation</div>
                        <div class="explanation-text">
                            {{ selectedDecision.DecisionExplanation }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal" :class="{ active: showPositionModal }" @click.self="closePositionModal">
                <div class="modal-content modal-position" v-if="selectedPosition">
                    <div class="modal-header">
                        <div class="modal-title">Position Details: {{ selectedPosition.symbol }}</div>
                        <button class="close-btn" @click="closePositionModal">Close</button>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Position Information</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Side</div>
                                <div class="info-value" :class="selectedPosition.side === 'LONG' ? 'result-positive' : 'result-negative'">
                                    {{ selectedPosition.side }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Entry Price</div>
                                <div class="info-value">${{ selectedPosition.entry_price.toFixed(4) }}</div>
                            </div>
                            <div class="info-item" v-if="selectedPosition.is_closed">
                                <div class="info-label">Exit Price</div>
                                <div class="info-value">${{ selectedPosition.close_price.toFixed(4) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Quantity</div>
                                <div class="info-value">{{ selectedPosition.quantity.toFixed(4) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Leverage</div>
                                <div class="info-value">{{ selectedPosition.leverage }}x</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">P/L</div>
                                <div class="info-value" :class="selectedPosition.realized_pl >= 0 ? 'result-positive' : 'result-negative'">
                                    {{ selectedPosition.realized_pl >= 0 ? '+' : '' }}${{ selectedPosition.realized_pl.toFixed(2) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section" v-if="positionDecisions.length > 0">
                        <div class="section-title">Trading Decisions ({{ positionDecisions.length }})</div>
                        <div class="decisions-list">
                            <div v-for="(decision, index) in positionDecisions.slice().reverse()" :key="decision.id" class="decision-card">
                                <span class="decision-number">#{{ positionDecisions.length - index }}</span>
                                <div class="decision-time">{{ formatDateTime(decision.created_at) }}</div>
                                <div class="decision-signals" style="margin: 10px 0;">
                                    <span class="decision-badge" :class="'badge-' + decision.final_decision.toLowerCase()">
                                        {{ decision.final_decision }}
                                    </span>
                                    <span class="signal-icon" :class="'signal-bg-' + decision.btc_ichimoku.toLowerCase()" :title="decision.btc_ichimoku">₿</span>
                                    <span class="signal-icon" :class="'signal-bg-' + decision.coin_ichimoku.toLowerCase()" :title="decision.coin_ichimoku">🪙</span>
                                    <span class="signal-icon" :class="'signal-bg-' + decision.activity.toLowerCase()" :title="decision.activity">📊</span>
                                    <span class="signal-icon" :class="'signal-bg-' + decision.fud_activity.toLowerCase()" :title="decision.fud_activity">⚡</span>
                                    <span class="signal-icon" :class="'signal-bg-' + decision.sentiment.toLowerCase()" :title="decision.sentiment">💭</span>
                                    <span v-if="decision.fud_attack === 'yes'" class="signal-icon fud-attack-warning" title="FUD Attack">⚠️</span>
                                </div>
                                <div class="explanation-text" style="margin-top: 10px;">
                                    {{ decision.decision_explanation }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section" v-if="positionSnapshots.length > 0">
                        <div class="section-title">Snapshots History</div>
                        <div class="chart-controls">
                            <button v-for="metric in snapshotMetrics" :key="metric.key" 
                                    class="chart-toggle" 
                                    :class="{ active: metric.visible }"
                                    @click="toggleMetric(metric.key)">
                                {{ metric.label }}
                            </button>
                        </div>
                        <div class="snapshots-chart-container">
                            <canvas id="snapshotsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    balanceHistory: [],
                    decisions: {},
                    positions: [],
                    assets: [],
                    selectedAsset: 'USDT',
                    showDecisionModal: false,
                    selectedDecision: null,
                    showPositionModal: false,
                    selectedPosition: null,
                    positionDecisions: [],
                    positionSnapshots: [],
                    chart: null,
                    snapshotsChart: null,
                    snapshotMetrics: [
                        { key: 'unrealized_pl', label: 'Unrealized P/L', visible: true, color: '#00ff88' },
                        { key: 'mark_price', label: 'Mark Price', visible: true, color: '#00ccff' },
                        { key: 'entry_price', label: 'Entry Price', visible: true, color: '#ffaa00' },
                        { key: 'amount', label: 'Amount', visible: false, color: '#ff4444' }
                    ]
                }
            },
            computed: {
                groupedDecisions() {
                    return this.decisions;
                }
            },
            methods: {
                async fetchData() {
                    try {
                        const [balanceRes, decisionsRes, positionsRes, assetsRes] = await Promise.all([
                            fetch(`/api/balance-history?asset=${this.selectedAsset}`),
                            fetch('/api/decisions'),
                            fetch('/api/positions'),
                            fetch('/api/assets')
                        ]);

                        const balanceData = await balanceRes.json();
                        const decisionsData = await decisionsRes.json();
                        const positionsData = await positionsRes.json();
                        const assetsData = await assetsRes.json();

                        this.balanceHistory = balanceData.history || [];
                        this.decisions = decisionsData.decisions || {};
                        this.positions = positionsData.positions || [];
                        this.assets = assetsData.assets || ['USDT'];

                        if (!this.assets.includes(this.selectedAsset) && this.assets.length > 0) {
                            this.selectedAsset = this.assets[0];
                        }

                        await this.$nextTick();
                        this.renderChart();
                    } catch (err) {
                        console.error('Failed to fetch data:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                async onAssetChange() {
                    try {
                        const response = await fetch(`/api/balance-history?asset=${this.selectedAsset}`);
                        const data = await response.json();
                        this.balanceHistory = data.history || [];
                        await this.$nextTick();
                        this.renderChart();
                    } catch (err) {
                        console.error('Failed to fetch balance history:', err);
                    }
                },
                renderChart() {
                    const ctx = document.getElementById('balanceChart');
                    
                    if (!ctx) {
                        console.error('Canvas element not found');
                        return;
                    }
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    if (!this.balanceHistory || this.balanceHistory.length === 0) {
                        return;
                    }

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.balanceHistory.map(p => {
                                const date = new Date(p.timestamp);
                                return date.toLocaleString('en-US', { 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            }),
                            datasets: [
                                {
                                    label: 'Balance',
                                    data: this.balanceHistory.map(p => p.balance),
                                    borderColor: '#00ff88',
                                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Available Balance',
                                    data: this.balanceHistory.map(p => p.available_balance),
                                    borderColor: '#00ccff',
                                    backgroundColor: 'rgba(0, 204, 255, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: false,
                                    pointRadius: 3,
                                    pointHoverRadius: 5
                                },
                                {
                                    label: 'Max Withdraw',
                                    data: this.balanceHistory.map(p => p.max_withdraw_amount),
                                    borderColor: '#ffaa00',
                                    backgroundColor: 'rgba(255, 170, 0, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: false,
                                    pointRadius: 3,
                                    pointHoverRadius: 5
                                },
                                {
                                    label: 'Cross Wallet Balance',
                                    data: this.balanceHistory.map(p => p.cross_wallet_balance),
                                    borderColor: '#ff44ff',
                                    backgroundColor: 'rgba(255, 68, 255, 0.1)',
                                    borderWidth: 1,
                                    tension: 0.4,
                                    fill: false,
                                    pointRadius: 2,
                                    pointHoverRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#00ff88',
                                        font: {
                                            family: "'Courier New', monospace",
                                            size: 14
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                }
                            }
                        }
                    });
                },
                async openDecisionDetail(decisionId) {
                    try {
                        const response = await fetch(`/api/decision-detail?id=${decisionId}`);
                        this.selectedDecision = await response.json();
                        this.showDecisionModal = true;
                    } catch (err) {
                        console.error('Failed to fetch decision details:', err);
                    }
                },
                closeDecisionModal() {
                    this.showDecisionModal = false;
                    this.selectedDecision = null;
                },
                async openPositionDetail(positionUUID) {
                    try {
                        const position = this.positions.find(p => p.uuid === positionUUID);
                        if (!position) return;

                        this.selectedPosition = position;

                        const [decisionsRes, snapshotsRes] = await Promise.all([
                            fetch(`/api/position-decisions?position_uuid=${positionUUID}`),
                            fetch(`/api/position-snapshots?position_uuid=${positionUUID}`)
                        ]);

                        const decisionsData = await decisionsRes.json();
                        const snapshotsData = await snapshotsRes.json();

                        this.positionDecisions = decisionsData.decisions || [];
                        this.positionSnapshots = snapshotsData.snapshots || [];

                        this.showPositionModal = true;

                        await this.$nextTick();
                        this.renderSnapshotsChart();
                    } catch (err) {
                        console.error('Failed to fetch position details:', err);
                    }
                },
                closePositionModal() {
                    this.showPositionModal = false;
                    this.selectedPosition = null;
                    this.positionDecisions = [];
                    this.positionSnapshots = [];
                    if (this.snapshotsChart) {
                        this.snapshotsChart.destroy();
                        this.snapshotsChart = null;
                    }
                },
                toggleMetric(key) {
                    const metric = this.snapshotMetrics.find(m => m.key === key);
                    if (metric) {
                        metric.visible = !metric.visible;
                        this.renderSnapshotsChart();
                    }
                },
                renderSnapshotsChart() {
                    const ctx = document.getElementById('snapshotsChart');
                    if (!ctx || !this.positionSnapshots || this.positionSnapshots.length === 0) {
                        return;
                    }

                    if (this.snapshotsChart) {
                        this.snapshotsChart.destroy();
                    }

                    const datasets = this.snapshotMetrics
                        .filter(metric => metric.visible)
                        .map(metric => ({
                            label: metric.label,
                            data: this.positionSnapshots.map(s => s[metric.key]),
                            borderColor: metric.color,
                            backgroundColor: metric.color + '33',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }));

                    this.snapshotsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.positionSnapshots.map(s => {
                                const date = new Date(s.created_at);
                                return date.toLocaleString('en-US', { 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            }),
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#00ff88',
                                        font: {
                                            family: "'Courier New', monospace",
                                            size: 12
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                }
                            }
                        }
                    });
                },
                formatDate(date) {
                    return new Date(date).toLocaleDateString();
                },
                formatDateTime(date) {
                    return new Date(date).toLocaleString();
                },
                formatTime(date) {
                    const d = new Date(date);
                    return d.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                getDecisionTooltip(decision) {
                    const tooltips = {
                        'LONG': 'LONG: Open a buy position - expecting price to go up',
                        'SHORT': 'SHORT: Open a sell position - expecting price to go down',
                        'EMPTY': 'EMPTY: No clear signal - conflicting indicators or insufficient data. Position will be closed if open, or no action taken if no position.'
                    };
                    return tooltips[decision] || decision;
                },
                getSignalTooltip(indicator, status) {
                    const descriptions = {
                        'BTC Ichimoku': {
                            'LONG': '₿ BTC Ichimoku: LONG - Bitcoin trend is bullish',
                            'SHORT': '₿ BTC Ichimoku: SHORT - Bitcoin trend is bearish',
                            'EMPTY': '₿ BTC Ichimoku: EMPTY - Bitcoin trend is neutral or unclear'
                        },
                        'Coin Ichimoku': {
                            'LONG': '🪙 Coin Ichimoku: LONG - Coin trend is bullish',
                            'SHORT': '🪙 Coin Ichimoku: SHORT - Coin trend is bearish',
                            'EMPTY': '🪙 Coin Ichimoku: EMPTY - Coin trend is neutral or unclear'
                        },
                        'Community Activity': {
                            'LONG': '📊 Community Activity: LONG - Sharp rise in community engagement',
                            'SHORT': '📊 Community Activity: SHORT - Sharp drop in community engagement',
                            'EMPTY': '📊 Community Activity: EMPTY - No significant change in activity'
                        },
                        'FUD Activity': {
                            'SHORT': '⚡ FUD Activity: SHORT - Sharp rise in FUD/negative sentiment',
                            'EMPTY': '⚡ FUD Activity: EMPTY - No significant FUD activity detected'
                        },
                        'Sentiment': {
                            'SHORT': '💭 Sentiment: SHORT - Declining sentiment with low score',
                            'EMPTY': '💭 Sentiment: EMPTY - Sentiment is stable or cannot generate signal alone'
                        }
                    };
                    
                    if (descriptions[indicator] && descriptions[indicator][status]) {
                        return descriptions[indicator][status];
                    }
                    return `${indicator}: ${status}`;
                },
                getTrendClass(trend) {
                    if (trend === 'LONG') return 'trend-up';
                    if (trend === 'SHORT') return 'trend-down';
                    return 'trend-flat';
                }
            },
            mounted() {
                this.fetchData();
                setTimeout(() => this.fetchData(), 3000);
                setInterval(() => this.fetchData(), 30000);
            }
        }).mount('#app');
    </script>
</body>
</html>
