<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUD Trading Bot - Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
            color: #00ff88;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid #00ff88;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 10px;
        }

        .chart-container {
            background: rgba(10, 14, 39, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .chart-title {
            color: #00ccff;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        #balanceChart {
            max-height: 400px;
        }

        .positions-section {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .positions-box {
            background: rgba(10, 14, 39, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .box-title {
            color: #00ccff;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .positions-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .position-item {
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-item:hover {
            background: rgba(0, 204, 255, 0.2);
            transform: translateX(5px);
        }

        .position-info {
            flex: 1;
        }

        .position-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .position-symbol {
            font-size: 1.2em;
            color: #00ff88;
            font-weight: bold;
        }

        .position-icons {
            display: flex;
            gap: 8px;
        }

        .icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 16px;
        }

        .icon-long {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
        }

        .icon-short {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid #ff4444;
        }

        .icon-ichimoku { background: rgba(138, 43, 226, 0.3); }
        .icon-community { background: rgba(255, 165, 0, 0.3); }
        .icon-fud { background: rgba(255, 0, 0, 0.3); }
        .icon-sentiment { background: rgba(0, 191, 255, 0.3); }

        .position-details-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
        }

        .detail-label {
            color: #888;
        }

        .detail-value {
            color: #00ccff;
            text-align: right;
        }

        .result-positive {
            color: #00ff88;
        }

        .result-negative {
            color: #ff4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00ccff;
        }

        .modal-title {
            font-size: 1.8em;
            color: #00ff88;
        }

        .close-btn {
            background: rgba(255, 68, 68, 0.3);
            border: 2px solid #ff4444;
            color: #ff4444;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 68, 68, 0.5);
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .section-title {
            color: #00ccff;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: rgba(0, 204, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00ccff;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #00ff88;
            font-size: 1.2em;
            font-weight: bold;
        }

        .history-item {
            background: rgba(0, 204, 255, 0.05);
            border: 1px solid #00ccff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-action {
            font-size: 1.1em;
            color: #00ff88;
            font-weight: bold;
            text-transform: uppercase;
        }

        .history-time {
            color: #888;
            font-size: 0.9em;
        }

        .history-reason {
            color: #00ccff;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .trend-graph {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .trend-item {
            background: rgba(10, 14, 39, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00ccff;
            text-align: center;
        }

        .trend-label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .trend-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .trend-up { color: #00ff88; }
        .trend-down { color: #ff4444; }
        .trend-flat { color: #ffaa00; }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.7);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: #00ccff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>📊 FUD Trading Bot Dashboard</h1>
            </div>

            <div v-if="loading" class="loading">
                ⚡ Loading data...
            </div>

            <template v-else>
                <div class="chart-container">
                    <div class="chart-title">Account Balance History</div>
                    <canvas id="balanceChart"></canvas>
                </div>

                <div class="positions-section">
                    <div class="positions-box">
                        <div class="box-title">Active Positions</div>
                        <div class="positions-list">
                            <div v-for="pos in activePositions" 
                                 :key="pos.id" 
                                 class="position-item"
                                 @click="openPositionDetail(pos.id)">
                                <div class="position-info">
                                    <div class="position-header-row">
                                        <span class="position-symbol">{{ pos.symbol }}</span>
                                        <div class="position-icons">
                                            <span class="icon" :class="pos.direction === 'LONG' ? 'icon-long' : 'icon-short'">
                                                {{ pos.direction === 'LONG' ? '↑' : '↓' }}
                                            </span>
                                            <span class="icon" :class="'icon-' + pos.reason" :title="pos.reason">
                                                {{ getReasonIcon(pos.reason) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="position-details-row">
                                        <div class="detail-label">Date:</div>
                                        <div class="detail-value">{{ formatDate(pos.date) }}</div>
                                        <div class="detail-label">Amount:</div>
                                        <div class="detail-value">${{ pos.amount.toFixed(2) }}</div>
                                        <div class="detail-label">Result:</div>
                                        <div class="detail-value" :class="pos.result >= 0 ? 'result-positive' : 'result-negative'">
                                            {{ pos.result >= 0 ? '+' : '' }}${{ pos.result.toFixed(2) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="positions-box">
                        <div class="box-title">Positions History</div>
                        <div class="positions-list">
                            <div v-for="pos in closedPositions" 
                                 :key="pos.id" 
                                 class="position-item"
                                 @click="openPositionDetail(pos.id)">
                                <div class="position-info">
                                    <div class="position-header-row">
                                        <span class="position-symbol">{{ pos.symbol }}</span>
                                        <div class="position-icons">
                                            <span class="icon" :class="pos.direction === 'LONG' ? 'icon-long' : 'icon-short'">
                                                {{ pos.direction === 'LONG' ? '↑' : '↓' }}
                                            </span>
                                            <span class="icon" :class="'icon-' + pos.reason" :title="pos.reason">
                                                {{ getReasonIcon(pos.reason) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="position-details-row">
                                        <div class="detail-label">Date:</div>
                                        <div class="detail-value">{{ formatDate(pos.date) }}</div>
                                        <div class="detail-label">Amount:</div>
                                        <div class="detail-value">${{ pos.amount.toFixed(2) }}</div>
                                        <div class="detail-label">Result:</div>
                                        <div class="detail-value" :class="pos.result >= 0 ? 'result-positive' : 'result-negative'">
                                            {{ pos.result >= 0 ? '+' : '' }}${{ pos.result.toFixed(2) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <div class="modal" :class="{ active: showModal }" @click.self="closeModal">
                <div class="modal-content" v-if="selectedPosition">
                    <div class="modal-header">
                        <div class="modal-title">Position Details: {{ selectedPosition.symbol }}</div>
                        <button class="close-btn" @click="closeModal">Close</button>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Position Information</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Direction</div>
                                <div class="info-value">{{ selectedPosition.direction }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Amount</div>
                                <div class="info-value">${{ selectedPosition.amount.toFixed(2) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Coins Amount</div>
                                <div class="info-value">{{ selectedPosition.coins_amount.toFixed(2) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Result</div>
                                <div class="info-value" :class="selectedPosition.result >= 0 ? 'result-positive' : 'result-negative'">
                                    {{ selectedPosition.result >= 0 ? '+' : '' }}${{ selectedPosition.result.toFixed(2) }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Opened At</div>
                                <div class="info-value">{{ formatDateTime(selectedPosition.opened_at) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Closed At</div>
                                <div class="info-value">{{ selectedPosition.closed_at ? formatDateTime(selectedPosition.closed_at) : 'Active' }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Position History</div>
                        <div v-for="(item, index) in selectedPosition.history" :key="index" class="history-item">
                            <div class="history-header">
                                <span class="history-action">{{ item.action }}</span>
                                <span class="history-time">{{ formatDateTime(item.timestamp) }}</span>
                            </div>
                            <div class="history-reason">{{ item.reason }}</div>
                            <div class="info-grid" style="margin-bottom: 10px;">
                                <div class="info-item">
                                    <div class="info-label">Amount</div>
                                    <div class="info-value">${{ item.amount.toFixed(2) }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Coins</div>
                                    <div class="info-value">{{ item.coins_amount.toFixed(2) }}</div>
                                </div>
                            </div>
                            <div class="section-title" style="font-size: 1em; margin-top: 10px;">Trend Analysis</div>
                            <div class="trend-graph">
                                <div class="trend-item">
                                    <div class="trend-label">Bitcoin</div>
                                    <div class="trend-value" :class="'trend-' + item.trend_analysis.bitcoin_trend">
                                        {{ item.trend_analysis.bitcoin_trend }}
                                    </div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-label">Coin</div>
                                    <div class="trend-value" :class="'trend-' + item.trend_analysis.coin_trend">
                                        {{ item.trend_analysis.coin_trend }}
                                    </div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-label">Activity</div>
                                    <div class="trend-value" :class="'trend-' + item.trend_analysis.activity_trend">
                                        {{ item.trend_analysis.activity_trend }}
                                    </div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-label">FUD Signal</div>
                                    <div class="trend-value" :class="item.trend_analysis.fud_signal ? 'result-negative' : 'result-positive'">
                                        {{ item.trend_analysis.fud_signal ? 'YES' : 'NO' }}
                                    </div>
                                </div>
                                <div class="trend-item">
                                    <div class="trend-label">Sentiment</div>
                                    <div class="trend-value" :class="'trend-' + item.trend_analysis.sentiment_trend">
                                        {{ item.trend_analysis.sentiment_trend }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    balanceHistory: [],
                    positions: [],
                    showModal: false,
                    selectedPosition: null,
                    chart: null
                }
            },
            computed: {
                activePositions() {
                    return this.positions.filter(p => p.status === 'active');
                },
                closedPositions() {
                    return this.positions.filter(p => p.status === 'closed');
                }
            },
            methods: {
                async fetchData() {
                    try {
                        const [balanceRes, positionsRes] = await Promise.all([
                            fetch('/api/balance-history'),
                            fetch('/api/positions-list')
                        ]);

                        const balanceData = await balanceRes.json();
                        const positionsData = await positionsRes.json();

                        this.balanceHistory = balanceData.history || [];
                        this.positions = positionsData.positions || [];

                        this.renderChart();
                    } catch (err) {
                        console.error('Failed to fetch data:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                renderChart() {
                    const ctx = document.getElementById('balanceChart');
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    if (this.balanceHistory.length === 0) {
                        return;
                    }

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.balanceHistory.map(p => {
                                const date = new Date(p.timestamp);
                                return date.toLocaleString('en-US', { 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            }),
                            datasets: [{
                                label: 'Balance ($)',
                                data: this.balanceHistory.map(p => p.balance),
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#00ff88',
                                        font: {
                                            family: "'Courier New', monospace",
                                            size: 14
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                }
                            }
                        }
                    });
                },
                async openPositionDetail(positionId) {
                    try {
                        const response = await fetch(`/api/position-detail?id=${positionId}`);
                        this.selectedPosition = await response.json();
                        this.showModal = true;
                    } catch (err) {
                        console.error('Failed to fetch position details:', err);
                    }
                },
                closeModal() {
                    this.showModal = false;
                    this.selectedPosition = null;
                },
                getReasonIcon(reason) {
                    const icons = {
                        ichimoku: '☁',
                        community: '👥',
                        fud: '⚠',
                        sentiment: '💭'
                    };
                    return icons[reason] || '?';
                },
                formatDate(date) {
                    return new Date(date).toLocaleDateString();
                },
                formatDateTime(date) {
                    return new Date(date).toLocaleString();
                }
            },
            mounted() {
                this.fetchData();
                setInterval(() => this.fetchData(), 30000);
            }
        }).mount('#app');
    </script>
</body>
</html>
