<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUD Trading Bot - Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
            color: #00ff88;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid #00ff88;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 10px;
        }

        .chart-container {
            background: rgba(10, 14, 39, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .chart-title {
            color: #00ccff;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        #balanceChart {
            max-height: 400px;
        }

        .positions-section {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .positions-box {
            background: rgba(10, 14, 39, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .box-title {
            color: #00ccff;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .positions-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .position-item {
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-item:hover {
            background: rgba(0, 204, 255, 0.2);
            transform: translateX(5px);
        }

        .position-info {
            flex: 1;
        }

        .position-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .position-symbol {
            font-size: 1.2em;
            color: #00ff88;
            font-weight: bold;
        }

        .position-icons {
            display: flex;
            gap: 8px;
        }

        .icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 16px;
        }

        .icon-long {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
        }

        .icon-short {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid #ff4444;
        }

        .icon-ichimoku { background: rgba(138, 43, 226, 0.3); }
        .icon-community { background: rgba(255, 165, 0, 0.3); }
        .icon-fud { background: rgba(255, 0, 0, 0.3); }
        .icon-sentiment { background: rgba(0, 191, 255, 0.3); }

        .position-details-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
        }

        .detail-label {
            color: #888;
        }

        .detail-value {
            color: #00ccff;
            text-align: right;
        }

        .result-positive {
            color: #00ff88;
        }

        .result-negative {
            color: #ff4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(10, 14, 39, 0.98);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00ccff;
        }

        .modal-title {
            font-size: 1.8em;
            color: #00ff88;
        }

        .close-btn {
            background: rgba(255, 68, 68, 0.3);
            border: 2px solid #ff4444;
            color: #ff4444;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 68, 68, 0.5);
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .section-title {
            color: #00ccff;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: rgba(0, 204, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00ccff;
        }

        .info-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #00ff88;
            font-size: 1.2em;
            font-weight: bold;
        }

        .history-item {
            background: rgba(0, 204, 255, 0.05);
            border: 1px solid #00ccff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-action {
            font-size: 1.1em;
            color: #00ff88;
            font-weight: bold;
            text-transform: uppercase;
        }

        .history-time {
            color: #888;
            font-size: 0.9em;
        }

        .history-reason {
            color: #00ccff;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .trend-graph {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .trend-item {
            background: rgba(10, 14, 39, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #00ccff;
            text-align: center;
        }

        .trend-label {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .trend-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .trend-up { color: #00ff88; }
        .trend-down { color: #ff4444; }
        .trend-flat { color: #ffaa00; }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.7);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: #00ccff;
        }

        .decisions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .decision-group {
            background: rgba(0, 204, 255, 0.05);
            border: 1px solid #00ccff;
            border-radius: 10px;
            padding: 15px;
        }

        .decision-group-header {
            color: #00ff88;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ccff;
        }

        .decision-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .decision-item {
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .decision-item:hover {
            background: rgba(0, 204, 255, 0.15);
            transform: translateX(5px);
        }

        .decision-time {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .decision-signals {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .decision-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .badge-long {
            background: rgba(0, 255, 136, 0.3);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .badge-short {
            background: rgba(255, 68, 68, 0.3);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .badge-empty {
            background: rgba(255, 170, 0, 0.3);
            border: 1px solid #ffaa00;
            color: #ffaa00;
        }

        .signal-icon {
            font-size: 1.1em;
            cursor: help;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .signal-icon:hover {
            transform: scale(1.1);
        }

        .signal-bg-long {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }

        .signal-bg-short {
            background: rgba(255, 68, 68, 0.3);
            border-color: #ff4444;
        }

        .signal-bg-empty {
            background: rgba(128, 128, 128, 0.3);
            border-color: #888;
        }

        .fud-attack-warning {
            color: #ff4444;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .explanation-text {
            background: rgba(0, 204, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00ccff;
            color: #00ff88;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>📊 FUD Trading Bot Dashboard</h1>
            </div>

            <div v-if="loading" class="loading">
                ⚡ Loading data...
            </div>

            <template v-else>
                <div class="chart-container">
                    <div class="chart-title">Account Balance History</div>
                    <canvas id="balanceChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Position History</div>
                    <div class="positions-list">
                        <div v-for="position in positionHistory.slice(0, 20)" 
                             :key="position.position_uuid" 
                             class="position-item"
                             @click="openPositionHistoryModal(position.position_uuid)">
                            <div class="position-info">
                                <div class="position-header-row">
                                    <div class="position-symbol">{{ position.symbol }}</div>
                                    <div class="position-icons">
                                        <span class="icon" :class="'icon-' + position.side.toLowerCase()">{{ position.side === 'LONG' ? '📈' : '📉' }}</span>
                                    </div>
                                </div>
                                <div class="position-details-row">
                                    <div>
                                        <div class="detail-label">Opened</div>
                                        <div class="detail-value">{{ formatTime(position.opened_at) }}</div>
                                    </div>
                                    <div>
                                        <div class="detail-label">Closed</div>
                                        <div class="detail-value">{{ formatTime(position.closed_at) }}</div>
                                    </div>
                                    <div>
                                        <div class="detail-label">Result</div>
                                        <div class="detail-value" :class="position.final_pl >= 0 ? 'result-positive' : 'result-negative'">{{ position.final_pl.toFixed(2) }} USDT</div>
                                    </div>
                                    <div>
                                        <div class="detail-label">Entry</div>
                                        <div class="detail-value">{{ position.entry_price.toFixed(4) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Trading Decisions</div>
                    <div class="decisions-container">
                        <div v-for="(decisions, symbol) in groupedDecisions" :key="symbol" class="decision-group">
                            <div class="decision-group-header">{{ symbol }}</div>
                            <div class="decision-list">
                                <div v-for="decision in decisions.slice(0, 10)" 
                                     :key="decision.id" 
                                     class="decision-item"
                                     @click="openDecisionDetail(decision.id)">
                                    <div class="decision-time">{{ formatTime(decision.created_at) }}</div>
                                    <div class="decision-signals">
                                        <span class="decision-badge" 
                                              :class="'badge-' + decision.decision.toLowerCase()"
                                              :title="getDecisionTooltip(decision.decision)">
                                            {{ decision.decision }}
                                        </span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.btc_ichimoku.toLowerCase()"
                                              :title="getSignalTooltip('BTC Ichimoku', decision.btc_ichimoku)">₿</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.coin_ichimoku.toLowerCase()"
                                              :title="getSignalTooltip('Coin Ichimoku', decision.coin_ichimoku)">🪙</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.activity.toLowerCase()"
                                              :title="getSignalTooltip('Community Activity', decision.activity)">📊</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.fud_activity.toLowerCase()"
                                              :title="getSignalTooltip('FUD Activity', decision.fud_activity)">⚡</span>
                                        <span class="signal-icon" 
                                              :class="'signal-bg-' + decision.sentiment.toLowerCase()"
                                              :title="getSignalTooltip('Sentiment', decision.sentiment)">💭</span>
                                        <span v-if="decision.fud_attack === 'yes'" 
                                              class="signal-icon fud-attack-warning" 
                                              title="⚠️ FUD Attack: Coordinated negative campaign detected">⚠️</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <div class="modal" :class="{ active: showPositionHistoryModal }" @click.self="closePositionHistoryModal">
                <div class="modal-content" v-if="selectedPositionHistory">
                    <div class="modal-header">
                        <div class="modal-title">Position History: {{ selectedPositionHistory.symbol }}</div>
                        <button class="close-btn" @click="closePositionHistoryModal">Close</button>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Position Information</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Side</div>
                                <div class="info-value">{{ selectedPositionHistory.direction }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Entry Price</div>
                                <div class="info-value">{{ selectedPositionHistory.amount?.toFixed(4) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Result</div>
                                <div class="info-value" :class="selectedPositionHistory.result >= 0 ? 'result-positive' : 'result-negative'">
                                    {{ selectedPositionHistory.result?.toFixed(2) }} USDT
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Duration</div>
                                <div class="info-value">{{ Math.round((new Date(selectedPositionHistory.closed_at) - new Date(selectedPositionHistory.opened_at)) / 3600000) }}h</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section" v-if="selectedPositionHistory.decisions && selectedPositionHistory.decisions.length > 0">
                        <div class="section-title">Trading Decisions ({{ selectedPositionHistory.decisions.length }})</div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <div v-for="(decision, index) in selectedPositionHistory.decisions" :key="decision.id" class="history-item">
                                <div class="history-header">
                                    <div class="history-action">#{{ index + 1 }} {{ decision.final_decision }}</div>
                                    <div class="history-time">{{ formatDateTime(decision.created_at) }}</div>
                                </div>
                                <div class="history-reason">{{ decision.decision_explanation }}</div>
                                <div class="trend-graph">
                                    <div class="trend-item">
                                        <div class="trend-label">BTC Ichimoku</div>
                                        <div class="trend-value" :class="getTrendClass(decision.btc_ichimoku)">{{ decision.btc_ichimoku }}</div>
                                    </div>
                                    <div class="trend-item">
                                        <div class="trend-label">Coin Ichimoku</div>
                                        <div class="trend-value" :class="getTrendClass(decision.coin_ichimoku)">{{ decision.coin_ichimoku }}</div>
                                    </div>
                                    <div class="trend-item">
                                        <div class="trend-label">Activity</div>
                                        <div class="trend-value" :class="getTrendClass(decision.activity)">{{ decision.activity }}</div>
                                    </div>
                                    <div class="trend-item">
                                        <div class="trend-label">FUD Activity</div>
                                        <div class="trend-value" :class="getTrendClass(decision.fud_activity)">{{ decision.fud_activity }}</div>
                                    </div>
                                    <div class="trend-item">
                                        <div class="trend-label">Sentiment</div>
                                        <div class="trend-value" :class="getTrendClass(decision.sentiment)">{{ decision.sentiment }}</div>
                                    </div>
                                    <div class="trend-item" v-if="decision.fud_attack === 'yes'">
                                        <div class="trend-label">FUD Attack</div>
                                        <div class="trend-value result-negative">YES ⚠️</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal" :class="{ active: showDecisionModal }" @click.self="closeDecisionModal">
                <div class="modal-content" v-if="selectedDecision">
                    <div class="modal-header">
                        <div class="modal-title">Decision Details: {{ selectedDecision.Symbol }}</div>
                        <button class="close-btn" @click="closeDecisionModal">Close</button>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Decision Information</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Final Decision</div>
                                <div class="info-value" :class="'badge-' + selectedDecision.FinalDecision.toLowerCase()">
                                    {{ selectedDecision.FinalDecision }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Position UUID</div>
                                <div class="info-value" style="font-size: 0.8em;">{{ selectedDecision.PositionUUID || 'N/A' }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date</div>
                                <div class="info-value">{{ formatDateTime(selectedDecision.CreatedAt) }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">FUD Attack</div>
                                <div class="info-value" :class="selectedDecision.FudAttack === 'yes' ? 'result-negative' : 'result-positive'">
                                    {{ selectedDecision.FudAttack === 'yes' ? 'YES ⚠️' : 'NO' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Signal Analysis</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">BTC Ichimoku</div>
                                <div class="info-value">{{ selectedDecision.BTCIchimoku }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Coin Ichimoku</div>
                                <div class="info-value">{{ selectedDecision.CoinIchimoku }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Activity</div>
                                <div class="info-value">{{ selectedDecision.Activity }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">FUD Activity</div>
                                <div class="info-value">{{ selectedDecision.FudActivity }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Sentiment</div>
                                <div class="info-value">{{ selectedDecision.Sentiment }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="section-title">Explanation</div>
                        <div class="explanation-text">
                            {{ selectedDecision.DecisionExplanation }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    balanceHistory: [],
                    positions: [],
                    decisions: {},
                    positionHistory: [],
                    showModal: false,
                    selectedPosition: null,
                    showDecisionModal: false,
                    selectedDecision: null,
                    showPositionHistoryModal: false,
                    selectedPositionHistory: null,
                    chart: null
                }
            },
            computed: {
                activePositions() {
                    return this.positions.filter(p => p.status === 'active');
                },
                closedPositions() {
                    return this.positions.filter(p => p.status === 'closed');
                },
                groupedDecisions() {
                    return this.decisions;
                }
            },
            methods: {
                async fetchData() {
                    try {
                        const [balanceRes, positionsRes, decisionsRes, posHistoryRes] = await Promise.all([
                            fetch('/api/balance-history'),
                            fetch('/api/positions-list'),
                            fetch('/api/decisions'),
                            fetch('/api/position-snapshots-history')
                        ]);

                        const balanceData = await balanceRes.json();
                        const positionsData = await positionsRes.json();
                        const decisionsData = await decisionsRes.json();
                        const posHistoryData = await posHistoryRes.json();

                        this.balanceHistory = balanceData.history || [];
                        this.positions = positionsData.positions || [];
                        this.decisions = decisionsData.decisions || {};
                        this.positionHistory = posHistoryData.positions || [];

                        await this.$nextTick();
                        this.renderChart();
                    } catch (err) {
                        console.error('Failed to fetch data:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                renderChart() {
                    const ctx = document.getElementById('balanceChart');
                    
                    if (!ctx) {
                        console.error('Canvas element not found');
                        return;
                    }
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    if (!this.balanceHistory || this.balanceHistory.length === 0) {
                        return;
                    }

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.balanceHistory.map(p => {
                                const date = new Date(p.timestamp);
                                return date.toLocaleString('en-US', { 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            }),
                            datasets: [
                                {
                                    label: 'Total Balance ($)',
                                    data: this.balanceHistory.map(p => p.total_balance),
                                    borderColor: '#00ff88',
                                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Available Balance ($)',
                                    data: this.balanceHistory.map(p => p.available_balance),
                                    borderColor: '#00ccff',
                                    backgroundColor: 'rgba(0, 204, 255, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: false,
                                    pointRadius: 3,
                                    pointHoverRadius: 5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#00ff88',
                                        font: {
                                            family: "'Courier New', monospace",
                                            size: 14
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#00ccff',
                                        font: {
                                            family: "'Courier New', monospace"
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: 'rgba(0, 204, 255, 0.2)'
                                    }
                                }
                            }
                        }
                    });
                },
                async openPositionDetail(positionId) {
                    try {
                        const response = await fetch(`/api/position-detail?id=${positionId}`);
                        this.selectedPosition = await response.json();
                        this.showModal = true;
                    } catch (err) {
                        console.error('Failed to fetch position details:', err);
                    }
                },
                closeModal() {
                    this.showModal = false;
                    this.selectedPosition = null;
                },
                async openDecisionDetail(decisionId) {
                    try {
                        const response = await fetch(`/api/decision-detail?id=${decisionId}`);
                        this.selectedDecision = await response.json();
                        this.showDecisionModal = true;
                    } catch (err) {
                        console.error('Failed to fetch decision details:', err);
                    }
                },
                closeDecisionModal() {
                    this.showDecisionModal = false;
                    this.selectedDecision = null;
                },
                async openPositionHistoryModal(positionUUID) {
                    try {
                        const [positionRes, decisionsRes] = await Promise.all([
                            fetch(`/api/position-detail?id=${positionUUID}`),
                            fetch(`/api/position-decisions?position_uuid=${positionUUID}`)
                        ]);
                        const positionData = await positionRes.json();
                        const decisionsData = await decisionsRes.json();
                        this.selectedPositionHistory = {
                            ...positionData,
                            decisions: decisionsData.decisions || []
                        };
                        this.showPositionHistoryModal = true;
                    } catch (err) {
                        console.error('Failed to fetch position history:', err);
                    }
                },
                closePositionHistoryModal() {
                    this.showPositionHistoryModal = false;
                    this.selectedPositionHistory = null;
                },
                getReasonIcon(reason) {
                    const icons = {
                        ichimoku: '☁',
                        community: '👥',
                        fud: '⚠',
                        sentiment: '💭'
                    };
                    return icons[reason] || '?';
                },
                formatDate(date) {
                    return new Date(date).toLocaleDateString();
                },
                formatDateTime(date) {
                    return new Date(date).toLocaleString();
                },
                formatTime(date) {
                    const d = new Date(date);
                    return d.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                getDecisionTooltip(decision) {
                    const tooltips = {
                        'LONG': 'LONG: Open a buy position - expecting price to go up',
                        'SHORT': 'SHORT: Open a sell position - expecting price to go down',
                        'EMPTY': 'EMPTY: No clear signal - conflicting indicators or insufficient data. Position will be closed if open, or no action taken if no position.'
                    };
                    return tooltips[decision] || decision;
                },
                getSignalTooltip(indicator, status) {
                    const descriptions = {
                        'BTC Ichimoku': {
                            'LONG': '₿ BTC Ichimoku: LONG - Bitcoin trend is bullish',
                            'SHORT': '₿ BTC Ichimoku: SHORT - Bitcoin trend is bearish',
                            'EMPTY': '₿ BTC Ichimoku: EMPTY - Bitcoin trend is neutral or unclear'
                        },
                        'Coin Ichimoku': {
                            'LONG': '🪙 Coin Ichimoku: LONG - Coin trend is bullish',
                            'SHORT': '🪙 Coin Ichimoku: SHORT - Coin trend is bearish',
                            'EMPTY': '🪙 Coin Ichimoku: EMPTY - Coin trend is neutral or unclear'
                        },
                        'Community Activity': {
                            'LONG': '📊 Community Activity: LONG - Sharp rise in community engagement',
                            'SHORT': '📊 Community Activity: SHORT - Sharp drop in community engagement',
                            'EMPTY': '📊 Community Activity: EMPTY - No significant change in activity'
                        },
                        'FUD Activity': {
                            'SHORT': '⚡ FUD Activity: SHORT - Sharp rise in FUD/negative sentiment',
                            'EMPTY': '⚡ FUD Activity: EMPTY - No significant FUD activity detected'
                        },
                        'Sentiment': {
                            'SHORT': '💭 Sentiment: SHORT - Declining sentiment with low score',
                            'EMPTY': '💭 Sentiment: EMPTY - Sentiment is stable or cannot generate signal alone'
                        }
                    };
                    
                    if (descriptions[indicator] && descriptions[indicator][status]) {
                        return descriptions[indicator][status];
                    }
                    return `${indicator}: ${status}`;
                },
                getTrendClass(trend) {
                    if (trend === 'LONG') return 'trend-up';
                    if (trend === 'SHORT') return 'trend-down';
                    return 'trend-flat';
                }
            },
            mounted() {
                this.fetchData();
                setTimeout(() => this.fetchData(), 3000);
                setInterval(() => this.fetchData(), 30000);
            }
        }).mount('#app');
    </script>
</body>
</html>
